<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>공지사항 | LS Works</title>
<link rel="stylesheet" href="style-base.css">
<link rel="stylesheet" href="notice-style.css">
</head>
<body>

<header>
  <div class="container header-flex">
    <a href="index.html" class="logo">
      <img src="lsw.png" alt="LS Works Logo">
      <span class="logo-text">Los Santos Works</span>
    </a>
    <nav>
      <ul>
        <li><a href="index.html">홈</a></li>
        <li><a href="about.html">기업 소개</a></li>
        <li><a href="services.html">직업 안내</a></li>
        <li><a href="notices.html" class="active">공지사항</a></li>
        <li><button id="login-btn">로그인</button></li>
      </ul>
    </nav>
  </div>
</header>

<main class="container">
  <section class="intro">
    <h1>공지사항</h1>
    <p>LS Works 관련 최신 소식과 공지를 확인하세요.</p>
    <button id="add-notice-btn" style="display:none;">공지사항 추가</button>
  </section>
  <section class="notice-cards" id="notice-cards"></section>
</main>

<!-- 공지사항 모달 -->
<div id="notice-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modal-title"></h3>
    <p id="modal-body"></p>
  </div>
</div>

<!-- 공지 추가 모달 -->
<div id="add-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>공지사항 추가</h3>
    <input type="text" id="new-title" placeholder="제목">
    <textarea id="new-content" placeholder="내용"></textarea>
    <button id="save-notice">저장</button>
  </div>
</div>

<!-- 로그인 모달 -->
<div id="login-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>관리자 로그인</h3>
    <input type="text" id="username" placeholder="아이디">
    <input type="password" id="password" placeholder="비밀번호">
    <button id="login-submit">로그인</button>
    <p id="login-msg" style="color:red;"></p>
  </div>
</div>

<footer>
  <p>“We Move. We Build. We Employ. – 일할 의지가 있는 모든 시민에게 기회는 열려 있습니다.”</p>
  <p>© 2025 LS Works. All rights reserved.</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzwjYMWl1DKf_e8iMSsdpW6qdt03blGxHQaBaaZyv--i_D_0YNBaM7Qpjr08tI4ECQPGQ/exec'; // 배포 후 URL
  const noticeCardsContainer = document.getElementById("notice-cards");

  function createNoticeCard(date, title, content){
    const card = document.createElement("div");
    card.classList.add("notice-card");
    card.dataset.title = title;
    card.dataset.content = content;

    const dateOnly = date.split("T")[0];
    card.innerHTML = `<span class="notice-date">${dateOnly}</span><p class="notice-text">${title}</p>`;

    card.addEventListener("click",()=>{
      document.getElementById("modal-title").textContent = title;
      document.getElementById("modal-body").textContent = content;
      document.getElementById("notice-modal").style.display="flex";
    });

    noticeCardsContainer.prepend(card);
  }

  // 모달 닫기
  document.querySelectorAll(".modal .close").forEach(btn=>{
    btn.addEventListener("click",()=>btn.parentElement.parentElement.style.display="none");
  });
  window.addEventListener("click", e=>{
    if(e.target.classList.contains("modal")) e.target.style.display="none";
  });

  // 로그인 & 공지 추가
  const loginBtn = document.getElementById("login-btn");
  const loginModal = document.getElementById("login-modal");
  const loginSubmit = document.getElementById("login-submit");
  const loginMsg = document.getElementById("login-msg");
  const addNoticeBtn = document.getElementById("add-notice-btn");
  const addModal = document.getElementById("add-modal");
  const saveNotice = document.getElementById("save-notice");

  loginBtn.addEventListener("click",()=>loginModal.style.display="flex");
  loginSubmit.addEventListener("click",()=>{
    const user=document.getElementById("username").value;
    const pass=document.getElementById("password").value;
    if(user==="admin" && pass==="1234"){
      loginModal.style.display="none";
      addNoticeBtn.style.display="inline-block";
      alert("로그인 성공!");
    } else loginMsg.textContent="아이디 또는 비밀번호가 잘못되었습니다.";
  });

  addNoticeBtn.addEventListener("click",()=>addModal.style.display="flex");

  saveNotice.addEventListener("click", async ()=>{
    const title = document.getElementById("new-title").value;
    const content = document.getElementById("new-content").value;
    const date = new Date().toISOString().split("T")[0];

    if(title && content){
      createNoticeCard(date, title, content);

      try {
        const res = await fetch(WEB_APP_URL,{
          method:'POST',
          body: JSON.stringify({date,title,content}),
          headers:{'Content-Type':'application/json'}
        });
        console.log(await res.text()); // 서버 응답 확인
      } catch(err){
        console.error("Google Sheets 저장 실패:",err);
        alert("Google Sheets 저장 실패! 서버 문제일 수 있습니다.");
      }

      addModal.style.display="none";
      document.getElementById("new-title").value='';
      document.getElementById("new-content").value='';
    }
  });

  // JSONP로 공지사항 불러오기
  function loadNotices(){
    const callbackName = "handleNotices";
    const existing = document.getElementById('jsonp-notices');
    if (existing) existing.remove();

    const script = document.createElement('script');
    script.id = 'jsonp-notices';
    script.src = `${WEB_APP_URL}?callback=${callbackName}`;
    script.onerror = () => console.error('JSONP script load error');
    document.body.appendChild(script);
  }

  window.handleNotices = function(data){
    if(!data || !data.notices) return;
    data.notices.forEach(item=>{
      createNoticeCard(item.date, item.title, item.content);
    });
  };

  loadNotices();
});
</script>

</body>
</html>
